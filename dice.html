<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üé≤ –ë—Ä–æ—Å–æ–∫ –∫—É–±–æ–≤</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>üé≤ –ë—Ä–æ—Å–æ–∫ –∫—É–±–æ–≤</h1>
    </header>

    <nav>
      <a href="index.html" class="btn-back">
        <span class="arrow">‚Üê</span>
        <span class="text">–í –º–µ–Ω—é</span>
      </a>
    </nav>

    <main>
      <section>
        <p>–í–≤–µ–¥–∏—Ç–µ —Ñ–æ—Ä–º—É–ª—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É–±–∏–∫. –ü—Ä–∏–º–µ—Ä—ã: <code>2d20 + 5</code>, <code>d6 + d4</code></p>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ñ–æ—Ä–º—É–ª—ã -->
        <div class="dice-form">
          <input type="text" id="formula" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2d20 + 3" />
          <button id="roll-formula">–ë—Ä–æ—Å–∏—Ç—å!</button>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –±—Ä–æ—Å–∫–æ–≤ -->
        <div class="dice-buttons">
          <button class="dice-btn" data-sides="4">d4</button>
          <button class="dice-btn" data-sides="6">d6</button>
          <button class="dice-btn" data-sides="8">d8</button>
          <button class="dice-btn" data-sides="10">d10</button>
          <button class="dice-btn" data-sides="12">d12</button>
          <button class="dice-btn" data-sides="20">d20</button>
          <button class="dice-btn" data-sides="100">d100</button>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div class="dice-result" id="result">
          –ì–æ—Ç–æ–≤ –∫ –±—Ä–æ—Å–∫—É...
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è -->
        <div class="dice-history">
          <h3>–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤</h3>
          <ul id="history-list"></ul>
          <button id="clear-history" class="btn-clear">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
      </section>
    </main>

    <footer>
      <p>–°–ª—É—á–∞–π–Ω–æ—Å—Ç—å —Ä–µ—à–∞–µ—Ç —Å—É–¥—å–±—É –≥–µ—Ä–æ–µ–≤</p>
    </footer>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const result = document.getElementById("result");
      const historyList = document.getElementById("history-list");
      const formulaInput = document.getElementById("formula");
      const rollFormulaBtn = document.getElementById("roll-formula");
      const clearHistoryBtn = document.getElementById("clear-history");

      // === –ü–∞—Ä—Å–µ—Ä –±—Ä–æ—Å–∫–æ–≤ ===
      function rollDice(formula) {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã
        formula = formula.trim();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–æ—Ä–º–∞—Ç
        const diceRegex = /(\d*)d(\d+)/gi;
        let total = 0;
        let breakdown = [];

        let match;
        let valid = false;

        // –ó–∞–º–µ–Ω—è–µ–º –∫–∞–∂–¥—ã–π dX –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞
        formula = formula.replace(diceRegex, (match, count, sides) => {
          valid = true;
          count = count ? parseInt(count) : 1;
          sides = parseInt(sides);

          if (sides <= 0 || count <= 0) return match;

          let sum = 0;
          const rolls = [];
          for (let i = 0; i < count; i++) {
            const roll = Math.floor(Math.random() * sides) + 1;
            rolls.push(roll);
            sum += roll;
          }
          total += sum;
          breakdown.push(`${match} ‚Üí [${rolls.join(', ')}] = ${sum}`);
          return sum;
        });

        // –ï—Å–ª–∏ –Ω–µ –±—ã–ª–æ –∫—É–±–∏–∫–æ–≤ ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ –≤—ã—á–∏—Å–ª–∏—Ç—å
        if (!valid) {
          try {
            const val = eval(formula);
            return { total: val, breakdown: [`= ${val}`] };
          } catch {
            return null;
          }
        }

        // –í—ã—á–∏—Å–ª—è–µ–º –∏—Ç–æ–≥ (—Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏)
        try {
          const finalTotal = eval(formula);
          breakdown.push(`–ò—Ç–æ–≥–æ: ${finalTotal}`);
          return { total: finalTotal, breakdown };
        } catch (e) {
          return null;
        }
      }

      // === –ë—Ä–æ—Å–æ–∫ –ø–æ —Ñ–æ—Ä–º—É–ª–µ ===
      function roll() {
        let formula = formulaInput.value.trim();

        // –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º d20
        if (!formula) {
          formula = "1d20";
          formulaInput.value = "1d20";
        }

        const rollResult = rollDice(formula);

        if (!rollResult) {
          result.innerHTML = `<span style="color:#c84e4e;">‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞</span>`;
          return;
        }

        result.innerHTML = `
          <strong>–§–æ—Ä–º—É–ª–∞:</strong> ${formula}<br>
          <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> <span class="big-roll">${rollResult.total}</span><br>
          <small>${rollResult.breakdown.join("<br>")}</small>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        const li = document.createElement("li");
        li.innerHTML = `<strong>${formula}</strong> ‚Üí ${rollResult.total}`;
        li.title = rollResult.breakdown.join("; ");
        historyList.prepend(li);

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 10 –∑–∞–ø–∏—Å—è–º–∏
        while (historyList.children.length > 10) {
          historyList.removeChild(historyList.lastChild);
        }
      }

      // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ===
      rollFormulaBtn.addEventListener("click", roll);
      formulaInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") roll();
      });

      // –ë—ã—Å—Ç—Ä—ã–µ –±—Ä–æ—Å–∫–∏
      document.querySelectorAll(".dice-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const sides = btn.dataset.sides;
          formulaInput.value = `1d${sides}`;
          roll();
        });
      });

      // –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
      clearHistoryBtn.addEventListener("click", () => {
        historyList.innerHTML = "";
        result.innerHTML = "–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.";
        setTimeout(() => {
          result.innerHTML = "–ì–æ—Ç–æ–≤ –∫ –±—Ä–æ—Å–∫—É...";
        }, 1500);
      });
    });
  </script>
</body>
</html>
