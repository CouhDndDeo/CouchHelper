<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üé≤ –ë—Ä–æ—Å–æ–∫ –∫—É–±–æ–≤</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>üé≤ –ë—Ä–æ—Å–æ–∫ –∫—É–±–æ–≤</h1>
    </header>

    <nav>
      <a href="index.html" class="btn-back">
        <span class="arrow">‚Üê</span>
        <span class="text">–í –º–µ–Ω—é</span>
      </a>
    </nav>

    <main>
      <p>–í–≤–µ–¥–∏—Ç–µ —Ñ–æ—Ä–º—É–ª—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É–±–∏–∫. –ü—Ä–∏–º–µ—Ä—ã: <code>2d20 + 5</code>, <code>d6 + d4</code></p>

      <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞ -->
      <div class="dice-form">
        <input type="text" id="formula" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2d20 + 3" />
        <button id="roll-formula">–ë—Ä–æ—Å–∏—Ç—å!</button>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –∫—É–±–∏–∫–æ–≤ -->
      <div class="dice-buttons">
        <button class="dice-btn" data-sides="4">d4</button>
        <button class="dice-btn" data-sides="6">d6</button>
        <button class="dice-btn" data-sides="8">d8</button>
        <button class="dice-btn" data-sides="10">d10</button>
        <button class="dice-btn" data-sides="12">d12</button>
        <button class="dice-btn" data-sides="20">d20</button>
        <button class="dice-btn" data-sides="100">d100</button>
      </div>

      <!-- –ö–†–ê–°–ò–í–´–ô –ë–õ–û–ö –†–ï–ó–£–õ–¨–¢–ê–¢–ê -->
      <div id="result" class="dice-result-container">
        <div class="dice-result-placeholder">
          –ì–æ—Ç–æ–≤ –∫ –±—Ä–æ—Å–∫—É...
        </div>
      </div>

      <!-- –ò–°–¢–û–†–ò–Ø –ë–†–û–°–ö–û–í -->
      <div class="dice-history">
        <h3>üìú –ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤</h3>
        <ul id="history-list"></ul>
        <button id="clear-history" class="btn-clear">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
      </div>
    </main>

    <footer>
      <p>–°–ª—É—á–∞–π–Ω–æ—Å—Ç—å —Ä–µ—à–∞–µ—Ç —Å—É–¥—å–±—É –≥–µ—Ä–æ–µ–≤</p>
    </footer>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const result = document.getElementById("result");
      const historyList = document.getElementById("history-list");
      const formulaInput = document.getElementById("formula");
      const rollFormulaBtn = document.getElementById("roll-formula");
      const clearHistoryBtn = document.getElementById("clear-history");

      function rollDice(formula) {
        formula = formula.trim();
        const diceRegex = /(\d*)d(\d+)/gi;
        let total = 0;
        let breakdown = [];

        let match;
        let valid = false;

        formula = formula.replace(diceRegex, (match, count, sides) => {
          valid = true;
          count = count ? parseInt(count) : 1;
          sides = parseInt(sides);

          if (sides <= 0 || count <= 0) return match;

          let sum = 0;
          const rolls = [];
          for (let i = 0; i < count; i++) {
            const roll = Math.floor(Math.random() * sides) + 1;
            rolls.push(roll);
            sum += roll;
          }
          total += sum;
          breakdown.push(`${match} ‚Üí [${rolls.join(', ')}] = ${sum}`);
          return sum;
        });

        if (!valid) {
          try {
            const val = eval(formula);
            return { total: val, breakdown: [`= ${val}`] };
          } catch {
            return null;
          }
        }

        try {
          const finalTotal = eval(formula);
          breakdown.push(`–ò—Ç–æ–≥–æ: ${finalTotal}`);
          return { total: finalTotal, breakdown };
        } catch (e) {
          return null;
        }
      }

      function roll() {
        let formula = formulaInput.value.trim();
        if (!formula) {
          formula = "1d20";
          formulaInput.value = "1d20";
        }

        const rollResult = rollDice(formula);

        if (!rollResult) {
          result.innerHTML = `
            <div class="dice-result-error">
              ‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞
            </div>
          `;
          return;
        }

        // –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        result.innerHTML = `
          <div class="dice-result-card">
            <div class="dice-formula">
              <span class="label">–§–æ—Ä–º—É–ª–∞:</span>
              <code>${formula}</code>
            </div>
            <div class="dice-total">
              üéØ <strong>${rollResult.total}</strong>
            </div>
            <div class="dice-breakdown">
              ${rollResult.breakdown.map(line => `<small>${line}</small>`).join('<br>')}
            </div>
          </div>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        const li = document.createElement("li");
        li.innerHTML = `
          <span class="history-formula">${formula}</span>
          <span class="history-result">‚Üí ${rollResult.total}</span>
        `;
        historyList.prepend(li);

        while (historyList.children.length > 10) {
          historyList.removeChild(historyList.lastChild);
        }
      }

      rollFormulaBtn.addEventListener("click", roll);
      formulaInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") roll();
      });

      document.querySelectorAll(".dice-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const sides = btn.dataset.sides;
          formulaInput.value = `1d${sides}`;
          roll();
        });
      });

      clearHistoryBtn.addEventListener("click", () => {
        historyList.innerHTML = "";
        result.innerHTML = '<div class="dice-result-placeholder">–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞</div>';
        setTimeout(() => {
          result.innerHTML = '<div class="dice-result-placeholder">–ì–æ—Ç–æ–≤ –∫ –±—Ä–æ—Å–∫—É...</div>';
        }, 1500);
      });
    });
  </script>
</body>
</html>
